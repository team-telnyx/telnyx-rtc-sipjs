name: "PR packages build"

on:
  pull_request:
    branches:
      - "*"

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect package changes
    runs-on: ubuntu-latest
    outputs:
      simple_user: ${{ steps.filter.outputs.simple_user }}
      user_agent: ${{ steps.filter.outputs.user_agent }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            simple_user:
              - "packages/telnyx-rtc-simple-user/**"
              - "package.json"
              - "yarn.lock"
            user_agent:
              - "packages/telnyx-rtc-user-agent/**"
              - "package.json"
              - "yarn.lock"

  build-simple-user:
    name: Build @telnyx/rtc-sipjs-simple-user
    needs: detect-changes
    if: needs.detect-changes.outputs.simple_user == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"
      - name: Install dependencies
        run: yarn install --immutable
      - name: Build package
        run: yarn workspace @telnyx/rtc-sipjs-simple-user run build

  build-user-agent:
    name: Build @telnyx/rtc-sipjs-user-agent
    needs: detect-changes
    if: needs.detect-changes.outputs.user_agent == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"
      - name: Install dependencies
        run: yarn install --immutable
      - name: Build package
        run: yarn workspace @telnyx/rtc-sipjs-user-agent run build
